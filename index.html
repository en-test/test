<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>物販購入ページ</title>
  <style>
    body { font-family: sans-serif; background:#f9f9f9; margin:0; padding:1rem; color:#333; }
    section { max-width:600px; margin:1rem auto; background:white; padding:1rem; border-radius:8px; box-shadow:0 0 10px rgba(0,0,0,0.1); }
    h2, h3 { text-align:center; }
    select { padding:0.3rem; }
    table{ width:100%; border-collapse:collapse; margin-top:1rem;}
    th,td{ border:1px solid #ccc; padding:0.5rem; text-align:center;}
    #totals{ margin:1rem 0; font-weight:bold; text-align:right; }
    button{ padding:0.7rem 1.2rem; margin:0.5rem; background:#007bff;color:white;border:none;border-radius:4px; cursor:pointer; }
    button:hover{ background:#0056b3; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
</head>
<body>
  <h2 id="ticket-title">チケット番号: </h2>

  <section id="page1">
    <h3>商品選択・数量入力</h3>
    <div id="totals">合計金額: 0 円 / 応援カード: 0 枚</div>
    <table id="goods-list">
      <thead><tr><th>商品名</th><th>価格</th><th>カード</th><th>数量</th></tr></thead>
      <tbody></tbody>
    </table>
    <button onclick="toConfirm()">確認へ</button>
  </section>

  <section id="pageConfirm" style="display:none">
    <h3>ご確認内容</h3>
    <div id="confirm-summary"></div>
    <button onclick="backToSelection()">戻る</button>
    <button onclick="toQR()">完了（QR表示）</button>
  </section>

  <section id="pageQR" style="display:none">
    <h3>こちらをスタッフに提示してください</h3>
    <div id="qrcode"></div>
  </section>

  <script>
    const SERIAL_MAP = {
      "abc123": "A0001",
      "def456": "A0002",
      "ghi789": "A0003",
    };

    const GOODS = [
      { id: 1,  name: "入場特典", price:0, bonus:3 },
      { id: 2,  name: "公演音声DLカード", price:2500, bonus:2 },
      { id: 3,  name: "上演台本「連星」", price:1500,  bonus:1 },
      { id: 4,  name: "ランダムブロマイド", price:1000,  bonus:1 },
      { id: 5,  name: "「連星」缶バッジセット", price:2000,  bonus:1 },
      { id: 6,  name: "「連星」缶バッジ単品（アルド）", price:400,  bonus:0 },
      { id: 7,  name: "「連星」缶バッジ単品（ミラ）", price:400,  bonus:0 },
      { id: 8,  name: "「連星」缶バッジ単品（シオン）", price:400,  bonus:0 },
      { id: 9,  name: "「連星」缶バッジ単品（レミアス）", price:400,  bonus:0 },
      { id:10, name: "「連星」缶バッジ単品（ヴェイル）", price:400,  bonus:0 },
      { id:11, name: "応援カード単品（1枚）", price:800, bonus:1 },
      { id:12, name: "応援カード単品（3枚・水深ステッカー付）", price:2200, bonus:3 },
      { id:13, name: "応援カード単品（3枚・水深缶バッジ付）", price:2200, bonus:3 },
      { id:14, name: "応援カード単品（5枚・水深ステッカー＆缶バッジ付）", price:3500, bonus:5 },
      { id:15, name: "水深ステッカー", price:300,  bonus:0 },
      { id:16, name: "水深缶バッジ", price:400,  bonus:0 }
    ];

    let serial = "";
    let ticket = "";
    let stateGoods = [];

    function init(){
      const params = new URLSearchParams(location.search);
      serial = params.get("serial");
      if(!serial){
        document.body.innerHTML = "<h2 style='color:red; text-align:center;'>シリアルがありません。</h2>";
        return;
      }
      ticket = SERIAL_MAP[serial];
      if(!ticket){
        document.body.innerHTML = `<h2 style='color:red; text-align:center;'>無効なシリアルです。</h2>`;
        return;
      }

      document.getElementById("ticket-title").innerText = `チケット番号: ${ticket}`;
      stateGoods = GOODS.map(g => ({...g, qty: g.id === 1 ? 1 : 0}));
      const tbody = document.querySelector("#goods-list tbody");
      tbody.innerHTML = stateGoods.map(g => {
        let options = '';
        const maxQty = 10;
        for (let i = 0; i <= maxQty; i++) {
          const selected = g.qty === i ? 'selected' : '';
          options += `<option value="${i}" ${selected}>${i}</option>`;
        }
        const disabled = g.id === 1 ? 'disabled' : '';
        return `
          <tr>
            <td>${g.name}</td>
            <td>￥${g.price}</td>
            <td>${g.bonus}</td>
            <td>
              <select data-id="${g.id}" onchange="onQty(this)" ${disabled}>
                ${options}
              </select>
            </td>
          </tr>`;
      }).join("");
      updateTotals();
    }

    function onQty(el){
      const id = +el.dataset.id, qty = Math.max(0, +el.value||0);
      const obj = stateGoods.find(g=>g.id===id);
      if(obj) obj.qty = qty;
      updateTotals();
    }

    function updateTotals(){
      const totalPrice = stateGoods.reduce((s,g)=>s+g.price*g.qty,0);
      const totalBonus = stateGoods.reduce((s,g)=>s+g.bonus*g.qty,0);
      document.getElementById("totals").innerText = 
        `合計金額: ${totalPrice} 円 / 応援カード: ${totalBonus} 枚`;
    }

    function toConfirm(){
      const purchased = stateGoods.filter(g=>g.qty>0);
      if(!purchased.length){
        alert("購入する数量を入力してください");
        return;
      }
      let html = `<p>チケット番号: ${ticket}</p>`;
      html += `<table><thead><tr><th>商品名</th><th>数量</th><th>小計</th><th>カード</th></tr></thead><tbody>`;
      purchased.forEach(g=> {
        html += `<tr><td>${g.name}</td><td>${g.qty}</td><td>￥${g.price*g.qty}</td><td>${g.bonus*g.qty}</td></tr>`;
      });
      const totalQty = purchased.reduce((s,g)=>s+g.qty,0);
      const totalPrice = purchased.reduce((s,g)=>s+g.price*g.qty,0);
      const totalBonus = purchased.reduce((s,g)=>s+g.bonus*g.qty,0);
      html += `</tbody></table>
               <p>合計点数: ${totalQty}</p><p>合計金額: ￥${totalPrice}</p><p>応援カード: ${totalBonus} 枚</p>`;
      document.getElementById("confirm-summary").innerHTML = html;
      document.getElementById("page1").style.display="none";
      document.getElementById("pageConfirm").style.display="block";
    }

    function backToSelection(){
      document.getElementById("page1").style.display="block";
      document.getElementById("pageConfirm").style.display="none";
      document.getElementById("pageQR").style.display="none";
    }

    function toQR(){
      document.getElementById("pageConfirm").style.display="none";
      document.getElementById("pageQR").style.display="block";
      const purchased = stateGoods.filter(g=>g.qty>0).map(g=>({id:g.id,qty:g.qty}));
      const totalQty = purchased.reduce((s,g)=>s+g.qty,0);
      const totalPrice = purchased.reduce((s,g)=>{
        const obj = GOODS.find(x=>x.id===g.id); return s + obj.price * g.qty;
      },0);
      const totalBonus = purchased.reduce((s,g)=>{
        const obj = GOODS.find(x=>x.id===g.id); return s + obj.bonus * g.qty;
      },0);
      const payload = { ticket, goods:purchased, totalQty, totalPrice, totalBonus };
      const txt = JSON.stringify(payload);
      const qrDiv = document.getElementById("qrcode");
      qrDiv.innerHTML = "";
      new QRCode(qrDiv, { text: txt, width:256, height:256 });
    }

    window.onload = init;
  </script>
</body>
</html>
