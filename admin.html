<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>物販管理 - 運営用</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body { font-family: sans-serif; padding: 1em; }
    #reader { width: 100%; max-width: 400px; margin-bottom: 1em; }
    .section { margin: 1.5em 0; }
    .entry { border: 1px solid #ccc; padding: 0.5em; margin-bottom: 0.5em; }
    details { background: #f1f1f1; padding: 0.5em; border-radius: 4px; }
  </style>
</head>
<body>

  <h1>物販管理（運営用）</h1>

  <div class="section">
    <h2>① QRコード読み取り</h2>
    <div id="reader"></div>
    <button onclick="startScan()">スキャン開始</button>
    <button onclick="stopScan()">スキャン停止</button>
  </div>

  <div class="section">
    <h2>② 読み取り結果</h2>
    <pre id="scan-result">未読み取り</pre>
    <button onclick="saveData()">保存する</button>
  </div>

  <div class="section">
    <h2>③ 保存データ一覧</h2>
    <button onclick="showData()">一覧を表示</button>
    <div id="data-list"></div>
  </div>

  <div class="section">
    <h2>④ CSV出力</h2>
    <button onclick="exportCSV()">CSVをダウンロード</button>
  </div>

  <script>
    // 物販商品情報 (購入画面と合わせて管理)
    const GOODS = [
      { id: 1, name: "Tシャツ", price: 3000, bonus: 1 },
      { id: 2, name: "タオル", price: 1500, bonus: 1 },
      { id: 3, name: "缶バッジ", price: 500, bonus: 0 }
      // ... 他商品を追加する場合はここに
    ];

    let lastScannedData = null;
    const STORAGE_KEY = "purchases";

    // 商品ID配列を展開し、商品名・価格などを補完
    function expandGoods(goodsArray) {
      return goodsArray.map(g => {
        const ref = GOODS.find(item => item.id === g.id);
        if (!ref) return { ...g, name: "不明な商品", price: 0, bonus: 0 };
        return {
          id: g.id,
          name: ref.name,
          price: ref.price,
          bonus: ref.bonus,
          qty: g.qty || 0
        };
      });
    }

    // QRコード読み取り開始
    let qrScanner = null;
    function startScan() {
      if (qrScanner) return; // 多重起動防止
      qrScanner = new Html5Qrcode("reader");
      qrScanner.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        (decodedText) => {
          try {
            const data = JSON.parse(decodedText);
            lastScannedData = data;

            // 展開済み商品リスト作成
            const expandedItems = expandGoods(data.goods || []);
            const displayData = {
              serial: data.serial || "",
              ticket: data.ticket || "",
              items: expandedItems
            };

            document.getElementById("scan-result").textContent = JSON.stringify(displayData, null, 2);

            stopScan(); // 読み取ったら自動停止
          } catch (e) {
            document.getElementById("scan-result").textContent = "読み取り失敗（JSON形式ではない）";
          }
        }
      ).catch(err => {
        alert("カメラの起動に失敗しました：" + err);
      });
    }

    function stopScan() {
      if (qrScanner) {
        qrScanner.stop().then(() => {
          qrScanner.clear();
          qrScanner = null;
        });
      }
    }

    // 保存処理
    function saveData() {
      if (!lastScannedData) {
        alert("保存するデータがありません。QRを読み取ってください。");
        return;
      }

      const items = expandGoods(lastScannedData.goods || []);

      const total = items.reduce((sum, g) => sum + g.price * g.qty, 0);
      const card = items.reduce((sum, g) => sum + g.bonus * g.qty, 0);

      const record = {
        serial: lastScannedData.serial || "",
        ticket: lastScannedData.ticket || "",
        items: items,
        total: total,
        card: card
      };

      const existing = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
      if (existing.some(e => e.serial === record.serial)) {
        alert("この整理番号は既に保存済みです。");
        return;
      }
      existing.push(record);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(existing));
      alert("保存しました。");
    }

    // 一覧表示
    function showData() {
      const list = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
      const container = document.getElementById("data-list");
      if (list.length === 0) {
        container.innerHTML = "<p>保存データはありません。</p>";
        return;
      }
      container.innerHTML = list.map(e => `
        <div class="entry">
          <strong>整理番号:</strong> ${e.serial}<br>
          <strong>チケット番号:</strong> ${e.ticket}<br>
          <strong>合計金額:</strong> ￥${e.total}<br>
          <strong>カード枚数:</strong> ${e.card}<br>
          <details>
            <summary>詳細（商品一覧）</summary>
            <pre>${JSON.stringify(e.items, null, 2)}</pre>
          </details>
        </div>
      `).join("");
    }

    // CSV出力
    function exportCSV() {
      const data = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
      if (data.length === 0) {
        alert("保存データがありません。");
        return;
      }
      let csv = "整理番号,チケット番号,合計金額,カード枚数\n";
      data.forEach(e => {
        csv += `${e.serial},${e.ticket},${e.total},${e.card}\n`;
      });

      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "purchase_log.csv";
      a.click();
    }
  </script>

</body>
</html>
