<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ç‰©è²©å—ä»˜ãƒšãƒ¼ã‚¸</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 1em;
      background: #f2f2f2;
    }

    .section {
      margin: 1.5em 0;
      padding: 1em;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }

    .entry {
      border: 1px solid #ccc;
      padding: 0.5em;
      margin-bottom: 0.5em;
      background: #fefefe;
      border-radius: 4px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 0.5em;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 0.4em;
      text-align: center;
      font-size: 0.85rem;
      white-space: nowrap;
    }

    th {
      background: #f0f0f0;
      color: #000;
    }

    tfoot tr th {
      font-weight: bold;
    }

    .btn-link {
      display: inline-block;
      background-color: #bdd4e6;
      color: #333;
      padding: 0.6em 1.2em;
      border-radius: 6px;
      font-size: 0.95em;
      font-weight: bold;
      text-decoration: none;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transition: background-color 0.2s, box-shadow 0.2s, transform 0.1s;
    }

    .btn-link:hover {
      background-color: #aac7df;  /* hoveræ™‚ */
      box-shadow: 0 4px 6px rgba(0,0,0,0.15);
      transform: translateY(-1px);
    }

    .btn-link:active {
      background-color: #95bad8;  /* activeæ™‚ */
      transform: translateY(1px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .btn-link:focus {
       outline: 2px solid #88b0d1;
      outline-offset: 2px;
    }

    .input-scan-wrap{
      display: flex;
      align-items: center;
      gap: 0.5em;
      margin: 0.5em 0;
    }

    .ticket-input {
      flex: 1;
      padding: 0.6em 1em;
      font-size: 0.95em;
      border-radius: 6px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }

    button {
      background-color: #bdd4e6; 
      color: #333;
      border: none;
      padding: 0.6em 1.2em;
      border-radius: 6px;
      margin: 0.3em 0.3em 0.3em 0;
      cursor: pointer;
      font-size: 0.95em;
      font-weight: bold;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transition: background-color 0.2s, box-shadow 0.2s, transform 0.1s;
    }

    button:hover {
      background-color: #aac7df;
      box-shadow: 0 4px 6px rgba(0,0,0,0.15);
      transform: translateY(-1px);
    }

    button:active {
      background-color: #95bad8;
      transform: translateY(1px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    button:focus {
      outline: 2px solid #88b0d1;
      outline-offset: 2px;
    }

    .btn-disabled {
      background-color: #ddd !important;
      color: #888 !important;
      cursor: not-allowed !important;
      box-shadow: none !important;
    }

    #reader { width: 100%; max-width: 400px; margin-bottom: 1em; }

  </style>
</head>
<body>

  <a href="purchases.html" target="_blank" class="btn-link">è³¼å…¥ãƒ‡ãƒ¼ã‚¿ä¸€è¦§ğŸ”—</a>
  <a href="inventory.html" target="_blank" class="btn-link">åœ¨åº«ç®¡ç†ãƒšãƒ¼ã‚¸ğŸ”—</a>

  <div class="section">
    <div class="input-scan-wrap">
      <input type="text" id="ticket-input" class="ticket-input" oninput="checkTicketDuplication()" placeholder="ãƒã‚±ãƒƒãƒˆç•ªå·"/>
      <button id="toggle-scan-btn" onclick="toggleScan()" disabled class="btn-disabled">ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹</button>
    </div>
    <p id="ticket-warning" style="color: red; font-weight: bold;"></p>
    <div id="reader" style="margin-top: 1em;"></div>
    <div id="scan-result" style="margin-top: 1em;"></div>
    <button onclick="saveData()">ä¿å­˜</button>
  </div>

<script>
const GOODS_MASTER = [
  { id: 1,  name: "å…¥å ´ç‰¹å…¸", price:0, bonus:3 },
  { id: 2,  name: "å•†å“1", price:2500, bonus:2 },
  { id: 3,  name: "å•†å“2", price:1500,  bonus:1 },
  { id: 4,  name: "å•†å“3", price:1000,  bonus:1 },
  { id: 5,  name: "å•†å“4", price:2000,  bonus:1 },
  { id: 6,  name: "å•†å“5", price:400,  bonus:0 },
  { id: 7,  name: "å•†å“6", price:400,  bonus:0 },
  { id: 8,  name: "å•†å“7", price:400,  bonus:0 },
  { id: 9,  name: "å•†å“8", price:400,  bonus:0 },
  { id:10, name: "å•†å“9", price:400,  bonus:0 },
  { id:11, name: "å•†å“10", price:800, bonus:1 },
  { id:12, name: "å•†å“11", price:2200, bonus:3 },
  { id:13, name: "å•†å“12", price:2200, bonus:3 },
  { id:14, name: "å•†å“13", price:3500, bonus:5 },
  { id:15, name: "å•†å“14", price:300,  bonus:0 },
  { id:16, name: "å•†å“15", price:400,  bonus:0 }
];

const STORAGE_KEY = "purchases";
const INVENTORY_KEY = "inventory";
let lastScannedData = null;
let qrScanner = null;

const customStock = [
  { id: 1, stock: 50 }, { id: 2, stock: 30 }, { id: 3, stock: 100 },
  { id: 4, stock: 70 }, { id: 5, stock: 90 }, { id: 6, stock: 60 },
  { id: 7, stock: 40 }, { id: 8, stock: 80 }, { id: 9, stock: 20 },
  { id: 10, stock: 55 }, { id: 11, stock: 25 }, { id: 12, stock: 35 },
  { id: 13, stock: 45 }, { id: 14, stock: 65 }, { id: 15, stock: 75 },
  { id: 16, stock: 85 }
];

window.onload = function() {
  // localStorageã«åœ¨åº«æ•°ã‚’è¨­å®š
  if (!localStorage.getItem(INVENTORY_KEY)) {
    localStorage.setItem(INVENTORY_KEY, JSON.stringify(customStock));
  }
}

function checkTicketDuplication() {
  const ticket = document.getElementById("ticket-input").value.trim();
  const existing = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
  const warning = document.getElementById("ticket-warning");
  const scanButton = document.getElementById("toggle-scan-btn");

  if (ticket === "") {
    warning.textContent = "ãƒã‚±ãƒƒãƒˆç•ªå·ãŒæœªå…¥åŠ›ã§ã™";
    scanButton.disabled = true;  // ãƒœã‚¿ãƒ³ç„¡åŠ¹åŒ–
    scanButton.classList.add("btn-disabled");
    return;
  }

  if (existing.some(d => d.ticket === ticket)) {
    warning.textContent = "ã“ã®ãƒã‚±ãƒƒãƒˆç•ªå·ã¯ã™ã§ã«è³¼å…¥ç™»éŒ²æ¸ˆã¿ã§ã™";
    scanButton.disabled = false;  // ãƒœã‚¿ãƒ³æœ‰åŠ¹åŒ–
    scanButton.classList.remove("btn-disabled");
  } else {
    warning.textContent = "";
    scanButton.disabled = false;  // ãƒœã‚¿ãƒ³æœ‰åŠ¹åŒ–
    scanButton.classList.remove("btn-disabled");
  }
}

function toggleScan() {
  const button = document.getElementById("toggle-scan-btn");
  if (qrScanner) {
    // åœæ­¢å‡¦ç†
    qrScanner.stop().then(() => {
      qrScanner.clear();
      qrScanner = null;
      button.textContent = "ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹";
    });
  } else {
    // é–‹å§‹å‡¦ç†
    qrScanner = new Html5Qrcode("reader");
    qrScanner.start({ facingMode:"environment" }, { fps:10, qrbox:250 },
      decodedText => {
        try {
          const data = JSON.parse(decodedText);
          data.ticket = document.getElementById("ticket-input").value.trim();
          data.items = (data.goods || []).map(item => {
            const m = GOODS_MASTER.find(g => g.id === item.id) || {};
            return { id: item.id, qty: item.qty, name: m.name || "ä¸æ˜", price: m.price||0, bonus: m.bonus||0 };
          });
          lastScannedData = data;
          displayScanResult(data);
          toggleScan();
        } catch(e) {
          document.getElementById("scan-result").textContent = "èª­ã¿å–ã‚Šå¤±æ•—";
        }
      }
    ).then(() => {
      button.textContent = "ã‚¹ã‚­ãƒ£ãƒ³åœæ­¢";
    }).catch(err => alert("ã‚«ãƒ¡ãƒ©èµ·å‹•å¤±æ•—ï¼š" + err));
  }
}

function displayScanResult(d) {
  let totalPrice = 0, totalBonus = 0;
  const inventory = getInventory();
  const warningLines = [];

  const rows = d.items.map((item, index) => {
    const inv = inventory.find(i => i.id === item.id);
    const available = inv ? inv.stock : 0;
    const selectedValue = item.qty <= available ? item.qty : available;

    if (item.qty > available) {
      warningLines.push(`ã€Œ${item.name}ã€ã®åœ¨åº«ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚ã€å¸Œæœ›æ•°ï¼š${item.qty}å€‹ã€€æ®‹æ•°ï¼š${available}å€‹ã€‘`);
    }

    d.items[index].qty = selectedValue;
    const amount = item.price * selectedValue;
    const bonusAmount = item.bonus * selectedValue;
    totalPrice += amount;
    totalBonus += bonusAmount;

    const selectOptions = Array.from({ length: available + 1 }, (_, i) =>
      `<option value="${i}" ${i === selectedValue ? "selected" : ""}>${i}</option>`
    ).join("");

    return `
      <tr>
        <td>${item.name}</td>
        <td>
          <select data-index="${index}" style="width: 100%;">${selectOptions}</select>
        </td>
        <td>ï¿¥${item.price}</td>
        <td>${bonusAmount}æš</td>
        <td>ï¿¥${amount}</td>
      </tr>`;
  }).join("");

  const warningHTML = warningLines.length > 0
    ? `<p style="color: red; font-weight: bold;">${warningLines.join("<br>")}</p>`
    : "";

  document.getElementById("scan-result").innerHTML = `
    ${warningHTML}
    <table>
      <thead><tr><th>å•†å“å</th><th>æ•°é‡</th><th>å˜ä¾¡</th><th>ã‚«ãƒ¼ãƒ‰</th><th>å°è¨ˆ</th></tr></thead>
      <tbody>${rows}</tbody>
      <tfoot>
        <tr>
          <th colspan="3">åˆè¨ˆ</th>
          <th id="total-bonus">${totalBonus}æš</th>
          <th id="total-price">ï¿¥${totalPrice}</th>
        </tr>
      </tfoot>
    </table>
    <p style="margin-top: 1rem; font-weight: bold; font-size: 1.1rem;">
      ãƒã‚±ãƒƒãƒˆç•ªå·ï¼š${d.ticket}<br>
      é‡‘é¡åˆè¨ˆï¼š<span id="display-total-price">${totalPrice}</span> å††<br>
      å¿œæ´ã‚«ãƒ¼ãƒ‰åˆè¨ˆï¼š<span id="display-total-bonus">${totalBonus}</span> æš
    </p>
    <div style="margin-top: 1rem;">
      <label>é ã‹ã‚Šé‡‘é¡ï¼š<input type="number" id="payment-input" style="width: 100px;" /></label>
      <p id="change-result" style="font-weight: bold;"></p>
    </div>
  `;

  const qtySelects = document.querySelectorAll('select[data-index]');
  qtySelects.forEach(select => {
    select.addEventListener("change", () => {
      const idx = parseInt(select.dataset.index);
      const newQty = parseInt(select.value) || 0;

      d.items[idx].qty = newQty;
      const item = d.items[idx];

      // è¡Œå†…å†è¨ˆç®—
      const row = select.closest("tr");
      const tdBonus = row.children[3];
      const tdAmount = row.children[4];

      const newAmount = item.price * item.qty;
      const newBonus = item.bonus * item.qty;

      tdBonus.textContent = `${newBonus}æš`;
      tdAmount.textContent = `ï¿¥${newAmount}`;

      // åˆè¨ˆå†è¨ˆç®—
      let newTotalPrice = 0, newTotalBonus = 0;
      d.items.forEach(item => {
        newTotalPrice += item.price * item.qty;
        newTotalBonus += item.bonus * item.qty;
      });

      document.getElementById("total-price").textContent = `ï¿¥${newTotalPrice}`;
      document.getElementById("total-bonus").textContent = `${newTotalBonus}æš`;
      document.getElementById("display-total-price").textContent = newTotalPrice;
      document.getElementById("display-total-bonus").textContent = newTotalBonus;

      // ãŠé‡£ã‚Šå†è¨ˆç®—
      const paymentInput = document.getElementById("payment-input");
      const changeResult = document.getElementById("change-result");
      const payment = parseInt(paymentInput.value, 10);
      if (!isNaN(payment)) {
        const change = payment - newTotalPrice;
        changeResult.textContent = `ãŠé‡£ã‚Šï¼šï¿¥${change >= 0 ? change : "ä¸è¶³ã—ã¦ã„ã¾ã™"}`;
      }
    });
  });

  // æ”¯æ‰•ã„å…¥åŠ›æ¬„ç›£è¦–
  const paymentInput = document.getElementById("payment-input");
  const changeResult = document.getElementById("change-result");
  paymentInput.addEventListener("input", () => {
    const payment = parseInt(paymentInput.value, 10);
    const currentTotal = d.items.reduce((sum, item) => sum + item.price * item.qty, 0);
    if (isNaN(payment)) {
      changeResult.textContent = "";
    } else {
      const change = payment - currentTotal;
      changeResult.textContent = `ãŠé‡£ã‚Šï¼šï¿¥${change >= 0 ? change : "ä¸è¶³ã—ã¦ã„ã¾ã™"}`;
    }
  });
}

function saveData() {
  if (!lastScannedData) return alert("QRã‚’èª­ã¿å–ã£ã¦ãã ã•ã„");
  const arr = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
  if (!isStockSufficient(lastScannedData.items)) {
    return alert("åœ¨åº«ãŒä¸è¶³ã—ã¦ã„ã‚‹å•†å“ãŒã‚ã‚Šã¾ã™ã€‚ä¿å­˜ã§ãã¾ã›ã‚“ã€‚");
  }
  arr.push(lastScannedData);
  localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
  reduceInventory(lastScannedData.items);
  alert("ä¿å­˜ã—ã¾ã—ãŸ");
  document.getElementById("scan-result").textContent = "";
  lastScannedData = null;
}

function initInventory() {
  // localStorageã«åœ¨åº«æ•°ã‚’è¨­å®š
  localStorage.setItem(INVENTORY_KEY, JSON.stringify(customStock));
  alert("åœ¨åº«ã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸ");
}

function getInventory() {
  return JSON.parse(localStorage.getItem(INVENTORY_KEY) || "[]");
}

function isStockSufficient(items) {
  const inventory = getInventory();
  for (const item of items) {
    const invItem = inventory.find(i => i.id === item.id);
    if (!invItem || invItem.stock < item.qty) {
      return false;
    }
  }
  return true;
}

function reduceInventory(items) {
  const inventory = getInventory();
  items.forEach(item => {
    const invItem = inventory.find(i => i.id === item.id);
    if (invItem) {
      invItem.stock -= item.qty;
      if (invItem.stock < 0) invItem.stock = 0;
    }
  });
  localStorage.setItem(INVENTORY_KEY, JSON.stringify(inventory));
}

</script>
</body>
</html>
