<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>物販管理 - 運営用</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body { font-family: sans-serif; padding: 1em; }
    #reader { width: 100%; max-width: 400px; margin-bottom: 1em; }
    .section { margin: 1.5em 0; }
    .entry { border: 1px solid #ccc; padding: 0.5em; margin-bottom: 0.5em; }
    table { border-collapse: collapse; width: 100%; margin-top: 0.5em; }
    th, td { border: 1px solid #ccc; padding: 0.4em; text-align: center; }
    th { background: #f0f0f0; }
  </style>
</head>
<body>

  <h1>物販管理（運営用）</h1>

  <div class="section">
    <h2>① QRコード読み取り</h2>
    <div id="reader"></div>
    <button onclick="startScan()">スキャン開始</button>
    <button onclick="stopScan()">スキャン停止</button>
  </div>

  <div class="section">
    <h2>② 読み取り結果</h2>
    <div id="scan-result">未読み取り</div>
    <button onclick="saveData()">保存する</button>
  </div>

  <div class="section">
    <h2>③ 保存データ一覧</h2>
    <button onclick="showData()">一覧を表示</button>
    <div id="data-list"></div>
  </div>

  <div class="section">
    <h2>④ CSV出力</h2>
    <button onclick="exportCSV()">CSVをダウンロード</button>
  </div>

  <div class="section">
    <h2>⑤ 保存データ削除</h2>
    <button onclick="clearStorage()">保存データを全削除</button>
  </div>

  <div class="section">
    <h2>⑥ 在庫一覧</h2>
    <button onclick="showInventory()">在庫を表示</button>
    <button onclick="initInventory()">在庫を初期化（全商品100）</button>
    <div id="inventory-list"></div>
  </div>

<script>
const GOODS_MASTER = [
  { id: 1, name: "Tシャツ", price: 3000, bonus: 1 },
  { id: 2, name: "タオル", price: 1500, bonus: 1 },
  { id: 3, name: "缶バッジ", price: 500, bonus: 0 },
  { id: 4, name: "アクリルキーホルダー", price: 800, bonus: 0 },
  { id: 5, name: "クリアファイル", price: 400, bonus: 0 },
  { id: 6, name: "ポスター", price: 700, bonus: 0 },
  { id: 7, name: "パンフレット", price: 1200, bonus: 1 },
  { id: 8, name: "ステッカー", price: 300, bonus: 0 },
  { id: 9, name: "スマホスタンド", price: 1300, bonus: 1 },
  { id:10, name: "マグカップ", price: 1100, bonus: 0 },
  { id:11, name: "ペンライト", price: 2500, bonus: 1 },
  { id:12, name: "ネックストラップ", price: 600, bonus: 0 },
  { id:13, name: "ピンズ", price: 500, bonus: 0 },
  { id:14, name: "キャップ", price: 1800, bonus: 1 },
  { id:15, name: "リストバンド", price: 450, bonus: 0 },
  { id:16, name: "キーチェーン", price: 750, bonus: 0 },
  { id:17, name: "パーカー", price: 4800, bonus: 2 },
  { id:18, name: "ロングTシャツ", price: 3500, bonus: 1 },
  { id:19, name: "タペストリー", price: 1600, bonus: 1 },
  { id:20, name: "メモ帳", price: 350, bonus: 0 },
  { id:21, name: "缶ケース", price: 900, bonus: 0 },
  { id:22, name: "ショルダーバッグ", price: 2800, bonus: 1 },
  { id:23, name: "ノート", price: 500, bonus: 0 },
  { id:24, name: "消しゴム", price: 200, bonus: 0 },
  { id:25, name: "ペンセット", price: 1000, bonus: 1 },
  { id:26, name: "うちわ", price: 300, bonus: 0 },
  { id:27, name: "ハンカチ", price: 700, bonus: 0 },
  { id:28, name: "タンブラー", price: 2200, bonus: 1 },
  { id:29, name: "ラバーストラップ", price: 600, bonus: 0 },
  { id:30, name: "ステーショナリーセット", price: 1500, bonus: 1 }
];

const STORAGE_KEY = "purchases";
const INVENTORY_KEY = "inventory";
let lastScannedData = null;
let qrScanner = null;

function startScan() {
  if (qrScanner) return;
  qrScanner = new Html5Qrcode("reader");
  qrScanner.start({ facingMode:"environment" }, { fps:10, qrbox:250 },
    decodedText => {
      try {
        const data = JSON.parse(decodedText);
        data.items = (data.goods || []).map(item => {
          const m = GOODS_MASTER.find(g => g.id === item.id) || {};
          return { id: item.id, qty: item.qty, name: m.name || "不明", price: m.price||0, bonus: m.bonus||0 };
        });
        lastScannedData = data;
        displayScanResult(data);
        stopScan();
      } catch(e) {
        document.getElementById("scan-result").textContent = "読み取り失敗";
      }
    }
  ).catch(err => alert("カメラ起動失敗：" + err));
}

function stopScan() {
  if (qrScanner) {
    qrScanner.stop().then(() => { qrScanner.clear(); qrScanner = null; });
  }
}

function displayScanResult(d) {
  let totalPrice = 0, totalBonus = 0;
  const rows = d.items.map(item => {
    const amount = item.price * item.qty;
    totalPrice += amount;
    totalBonus += item.bonus * item.qty;
    return `<tr><td>${item.name}</td><td>${item.qty}</td><td>￥${item.price}</td><td>${item.bonus}</td><td>￥${amount}</td></tr>`;
  }).join("");
  document.getElementById("scan-result").innerHTML = `
    <table>
      <thead><tr><th>商品名</th><th>数量</th><th>単価</th><th>カード</th><th>小計</th></tr></thead>
      <tbody>${rows}</tbody>
      <tfoot><tr><th colspan="4">合計</th><th>￥${totalPrice}</th></tr></tfoot>
    </table>
    <p>チケット番号: ${d.ticket}<br>応援カード合計: ${totalBonus} 枚</p>
  `;
}

function saveData() {
  if (!lastScannedData) return alert("QRを読み取ってください");
  const arr = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
  if (arr.some(e => e.ticket === lastScannedData.ticket)) {
    return alert("既に保存済みです");
  }
  if (!isStockSufficient(lastScannedData.items)) {
    return alert("在庫が不足している商品があります。保存できません。");
  }
  arr.push(lastScannedData);
  localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
  reduceInventory(lastScannedData.items);
  alert("保存しました");
  document.getElementById("scan-result").textContent = "未読み取り";
  lastScannedData = null;
}

function showData() {
  const arr = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
  const c = document.getElementById("data-list");
  if (arr.length === 0) return c.innerHTML = "<p>保存データはありません</p>";
  c.innerHTML = arr.map(d => {
    const rows = d.items.map(i => {
      const amt = i.price * i.qty;
      return `<tr><td>${i.name}</td><td>${i.qty}</td><td>￥${i.price}</td><td>￥${amt}</td></tr>`;
    }).join("");
    return `
      <div class="entry">
        <strong>チケット: ${d.ticket}</strong>
        <table>
          <thead><tr><th>商品</th><th>数量</th><th>単価</th><th>小計</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>
      </div>`;
  }).join("");
}

function exportCSV() {
  const arr = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
  if (arr.length === 0) return alert("保存データはありません");
  let csv = "ticket,id,name,price,qty,sub,bonus\n";
  arr.forEach(d => {
    d.items.forEach(i => {
      csv += [d.ticket, i.id, i.name, i.price, i.qty, i.price*i.qty, i.bonus*i.qty].join(",") + "\n";
    });
  });
  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "purchases.csv"; a.click();
  URL.revokeObjectURL(url);
}

function clearStorage() {
  if (confirm("すべての保存データを削除します。よろしいですか？")) {
    localStorage.removeItem(STORAGE_KEY);
    alert("保存データを削除しました。");
    document.getElementById("data-list").innerHTML = "";
  }
}

function initInventory(defaultStock = 100) {
  if (!localStorage.getItem(INVENTORY_KEY)) {
    const inv = GOODS_MASTER.map(item => ({ id: item.id, stock: defaultStock }));
    localStorage.setItem(INVENTORY_KEY, JSON.stringify(inv));
    alert("在庫を初期化しました");
  }
}

function getInventory() {
  return JSON.parse(localStorage.getItem(INVENTORY_KEY) || "[]");
}

function isStockSufficient(items) {
  const inventory = getInventory();
  for (const item of items) {
    const invItem = inventory.find(i => i.id === item.id);
    if (!invItem || invItem.stock < item.qty) {
      return false;
    }
  }
  return true;
}

function reduceInventory(items) {
  const inventory = getInventory();
  items.forEach(item => {
    const invItem = inventory.find(i => i.id === item.id);
    if (invItem) {
      invItem.stock -= item.qty;
      if (invItem.stock < 0) invItem.stock = 0;
    }
  });
  localStorage.setItem(INVENTORY_KEY, JSON.stringify(inventory));
}

function showInventory() {
  const inventory = getInventory();
  const rows = GOODS_MASTER.map(g => {
    const inv = inventory.find(i => i.id === g.id);
    const stock = inv ? inv.stock : "不明";
    return `<tr><td>${g.name}</td><td>${stock}</td></tr>`;
  }).join("");
  document.getElementById("inventory-list").innerHTML = `
    <table><thead><tr><th>商品名</th><th>在庫数</th></tr></thead><tbody>${rows}</tbody></table>
  `;
}
</script>
</body>
</html>
