<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>物販管理 - 運営用</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body { font-family: sans-serif; padding: 1em; }
    #reader { width: 100%; max-width: 400px; margin-bottom: 1em; }
    .section { margin: 1.5em 0; }
    .entry { border: 1px solid #ccc; padding: 0.5em; margin-bottom: 0.5em; }
    table {
      border-collapse: collapse;
      width: 100%;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 0.5em;
      text-align: center;
    }
    th {
      background-color: #f0f0f0;
    }
  </style>
</head>
<body>

  <h1>物販管理（運営用）</h1>

  <div class="section">
    <h2>① QRコード読み取り</h2>
    <div id="reader"></div>
    <button onclick="startScan()">スキャン開始</button>
    <button onclick="stopScan()">スキャン停止</button>
  </div>

  <div class="section">
    <h2>② 読み取り結果</h2>
    <div id="scan-result" style="white-space: normal; border: 1px solid #ccc; padding: 1em; min-height: 100px;">
      未読み取り
    </div>
    <button onclick="saveData()">保存する</button>
  </div>

  <div class="section">
    <h2>③ 保存データ一覧</h2>
    <button onclick="showData()">一覧を表示</button>
    <div id="data-list"></div>
  </div>

  <div class="section">
    <h2>④ CSV出力</h2>
    <button onclick="exportCSV()">CSVをダウンロード</button>
  </div>

  <script>
    let lastScannedData = null;
    const STORAGE_KEY = "purchases";

    // QRコード読み取り開始
    let qrScanner = null;
    function startScan() {
      qrScanner = new Html5Qrcode("reader");
      qrScanner.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        (decodedText) => {
          try {
            const data = JSON.parse(decodedText);

            // 商品IDだけの場合は補完したいならここでできる（運営側で商品マスタ持つなど）
            // ここでは商品IDに対応する名前などを展開例
            // 例の商品マスタ（必要に応じて編集してください）
            const productMaster = {
              1: { name: "Tシャツ", price: 3000, bonus: 1 },
              2: { name: "タオル", price: 1500, bonus: 1 },
              3: { name: "缶バッジ", price: 500, bonus: 0 }
            };

            // goods → items にしてる想定なら以下も調整してください
            const itemsRaw = data.goods || data.items || [];

            // 商品情報を補完
            const expandedItems = itemsRaw.map(item => {
              const master = productMaster[item.id] || {};
              return {
                id: item.id,
                name: master.name || "不明な商品",
                price: master.price || 0,
                bonus: master.bonus || 0,
                qty: item.qty || 0
              };
            });

            const displayData = {
              serial: data.serial || "",
              ticket: data.ticket || "",
              items: expandedItems
            };

            lastScannedData = displayData;

            document.getElementById("scan-result").innerHTML = renderScanResult(displayData);
            stopScan(); // 読み取ったら自動で停止
          } catch (e) {
            document.getElementById("scan-result").textContent = "読み取り失敗（JSON形式ではない）";
            lastScannedData = null;
          }
        }
      ).catch(err => {
        alert("カメラの起動に失敗しました：" + err);
      });
    }

    function stopScan() {
      if (qrScanner) {
        qrScanner.stop().then(() => {
          qrScanner.clear();
        });
      }
    }

    function renderScanResult(data) {
      let html = `<p><strong>整理番号:</strong> ${data.serial}</p>`;
      html += `<p><strong>チケット番号:</strong> ${data.ticket}</p>`;

      if (!data.items || data.items.length === 0) {
        html += `<p>商品データなし</p>`;
      } else {
        html += `<table><thead><tr><th>商品名</th><th>単価(円)</th><th>数量</th><th>小計(円)</th><th>カード枚数</th></tr></thead><tbody>`;

        data.items.forEach(item => {
          const subtotal = item.price * item.qty;
          const cardCount = item.bonus * item.qty;
          html += `<tr>
            <td>${item.name}</td>
            <td>${item.price.toLocaleString()}</td>
            <td>${item.qty}</td>
            <td>${subtotal.toLocaleString()}</td>
            <td>${cardCount}</td>
          </tr>`;
        });

        html += `</tbody></table>`;
      }
      return html;
    }

    // 保存処理
    function saveData() {
      if (!lastScannedData) {
        alert("保存するデータがありません。QRを読み取ってください。");
        return;
      }
      const existing = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
      if (existing.some(e => e.serial === lastScannedData.serial)) {
        alert("この整理番号は既に保存済みです。");
        return;
      }

      // 合計金額・カード枚数を計算して追加して保存
      const total = lastScannedData.items.reduce((sum, item) => sum + (item.price * item.qty), 0);
      const card = lastScannedData.items.reduce((sum, item) => sum + (item.bonus * item.qty), 0);

      const saveObj = {
        serial: lastScannedData.serial,
        ticket: lastScannedData.ticket,
        total,
        card,
        items: lastScannedData.items
      };

      existing.push(saveObj);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(existing));
      alert("保存しました。");
    }

    // 一覧表示
    function showData() {
      const list = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
      const container = document.getElementById("data-list");
      if (list.length === 0) {
        container.innerHTML = "<p>保存データはありません。</p>";
        return;
      }
      container.innerHTML = list.map(e => `
        <div class="entry">
          <strong>整理番号:</strong> ${e.serial}<br>
          <strong>チケット番号:</strong> ${e.ticket}<br>
          <strong>合計金額:</strong> ￥${e.total.toLocaleString()}<br>
          <strong>カード枚数:</strong> ${e.card}<br>
          <details>
            <summary>詳細</summary>
            <table>
              <thead><tr><th>商品名</th><th>単価(円)</th><th>数量</th><th>小計(円)</th><th>カード枚数</th></tr></thead>
              <tbody>
                ${e.items.map(item => `
                  <tr>
                    <td>${item.name}</td>
                    <td>${item.price.toLocaleString()}</td>
                    <td>${item.qty}</td>
                    <td>${(item.price * item.qty).toLocaleString()}</td>
                    <td>${item.bonus * item.qty}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </details>
        </div>
      `).join("");
    }

    // CSV出力
    function exportCSV() {
      const data = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
      if (data.length === 0) {
        alert("保存データがありません。");
        return;
      }
      let csv = "整理番号,チケット番号,合計金額,カード枚数\n";
      data.forEach(e => {
        csv += `${e.serial},${e.ticket},${e.total},${e.card}\n`;
      });

      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "purchase_log.csv";
      a.click();
    }
  </script>

</body>
</html>
