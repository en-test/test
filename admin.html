<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>物販管理 - 運営用</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body { font-family: sans-serif; padding: 1em; }
    #reader { width: 100%; max-width: 400px; margin-bottom: 1em; }
    .section { margin: 1.5em 0; }
    .entry { border: 1px solid #ccc; padding: 0.5em; margin-bottom: 0.5em; }
    details { margin-top: 0.5em; }
  </style>
</head>
<body>

  <h1>物販管理（運営用）</h1>

  <div class="section">
    <h2>① QRコード読み取り</h2>
    <div id="reader"></div>
    <button onclick="startScan()">スキャン開始</button>
    <button onclick="stopScan()">スキャン停止</button>
  </div>

  <div class="section">
    <h2>② 読み取り結果</h2>
    <pre id="scan-result">未読み取り</pre>
    <button onclick="saveData()">保存する</button>
  </div>

  <div class="section">
    <h2>③ 保存データ一覧</h2>
    <button onclick="showData()">一覧を表示</button>
    <div id="data-list"></div>
  </div>

  <div class="section">
    <h2>④ CSV出力</h2>
    <button onclick="exportCSV()">CSVをダウンロード</button>
  </div>

  <div class="section">
    <h2>⑤ 保存データ削除</h2>
    <button onclick="clearStorage()">保存データを全削除</button>
  </div>

<script>
const GOODS_MASTER = [
  { id: 1, name: "Tシャツ", price: 3000, bonus: 1 },
  { id: 2, name: "タオル", price: 1500, bonus: 1 },
  { id: 3, name: "缶バッジ", price: 500, bonus: 0 },
  { id: 4, name: "アクリルキーホルダー", price: 800, bonus: 0 },
  { id: 5, name: "クリアファイル", price: 400, bonus: 0 },
  { id: 6, name: "ポスター", price: 700, bonus: 0 },
  { id: 7, name: "パンフレット", price: 1200, bonus: 1 },
  { id: 8, name: "ステッカー", price: 300, bonus: 0 },
  { id: 9, name: "スマホスタンド", price: 1300, bonus: 1 },
  { id:10, name: "マグカップ", price: 1100, bonus: 0 },
  { id:11, name: "ペンライト", price: 2500, bonus: 1 },
  { id:12, name: "ネックストラップ", price: 600, bonus: 0 },
  { id:13, name: "ピンズ", price: 500, bonus: 0 },
  { id:14, name: "キャップ", price: 1800, bonus: 1 },
  { id:15, name: "リストバンド", price: 450, bonus: 0 },
  { id:16, name: "キーチェーン", price: 750, bonus: 0 },
  { id:17, name: "パーカー", price: 4800, bonus: 2 },
  { id:18, name: "ロングTシャツ", price: 3500, bonus: 1 },
  { id:19, name: "タペストリー", price: 1600, bonus: 1 },
  { id:20, name: "メモ帳", price: 350, bonus: 0 },
  { id:21, name: "缶ケース", price: 900, bonus: 0 },
  { id:22, name: "ショルダーバッグ", price: 2800, bonus: 1 },
  { id:23, name: "ノート", price: 500, bonus: 0 },
  { id:24, name: "消しゴム", price: 200, bonus: 0 },
  { id:25, name: "ペンセット", price: 1000, bonus: 1 },
  { id:26, name: "うちわ", price: 300, bonus: 0 },
  { id:27, name: "ハンカチ", price: 700, bonus: 0 },
  { id:28, name: "タンブラー", price: 2200, bonus: 1 },
  { id:29, name: "ラバーストラップ", price: 600, bonus: 0 },
  { id:30, name: "ステーショナリーセット", price: 1500, bonus: 1 }
];

  const STORAGE_KEY = "purchases";
  let lastScannedData = null;
  let qrScanner = null;

  function startScan() {
    if (qrScanner) return;
    qrScanner = new Html5Qrcode("reader");
    qrScanner.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      (decodedText) => {
        try {
          const data = JSON.parse(decodedText);
          if (Array.isArray(data.goods)) {
            data.items = data.goods.map(item => {
              const master = GOODS_MASTER.find(g => g.id === item.id);
              return {
                id: item.id,
                qty: item.qty,
                name: master ? master.name : "不明な商品",
                price: master ? master.price : 0,
                bonus: master ? master.bonus : 0
              };
            });
          } else {
            data.items = [];
          }

          lastScannedData = data;
          document.getElementById("scan-result").textContent = formatReadable(data);
          stopScan();
        } catch {
          document.getElementById("scan-result").textContent = "読み取り失敗（JSON形式ではない）";
        }
      }
    ).catch(err => {
      alert("カメラの起動に失敗しました：" + err);
    });
  }

  function stopScan() {
    if (qrScanner) {
      qrScanner.stop().then(() => {
        qrScanner.clear();
        qrScanner = null;
      });
    }
  }

  function saveData() {
    if (!lastScannedData) {
      alert("保存するデータがありません。");
      return;
    }
    let purchases = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
    if (purchases.some(e => e.ticket === lastScannedData.ticket)) {
      alert("このチケット番号は既に保存済みです。");
      return;
    }
    const totalPrice = lastScannedData.items.reduce((acc, cur) => acc + cur.price * cur.qty, 0);
    const totalBonus = lastScannedData.items.reduce((acc, cur) => acc + cur.bonus * cur.qty, 0);

    purchases.push({
      ticket: lastScannedData.ticket,
      items: lastScannedData.items,
      totalPrice,
      totalBonus
    });
    localStorage.setItem(STORAGE_KEY, JSON.stringify(purchases));
    alert("保存しました。");
  }

  function showData() {
    const purchases = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
    const container = document.getElementById("data-list");
    if (purchases.length === 0) {
      container.innerHTML = "<p>保存データはありません。</p>";
      return;
    }

    container.innerHTML = purchases.map(p => `
      <div class="entry">
        <strong>チケット番号: ${p.ticket}</strong><br>
        合計金額: ￥${p.totalPrice.toLocaleString()}<br>
        応援カード枚数: ${p.totalBonus}<br>
        <table>
          <thead><tr><th>ID</th><th>商品名</th><th>数量</th><th>金額</th><th>カード</th></tr></thead>
          <tbody>
            ${p.items.map(i => `
              <tr>
                <td>${i.id}</td>
                <td>${i.name}</td>
                <td>${i.qty}</td>
                <td>￥${(i.qty * i.price).toLocaleString()}</td>
                <td>${i.qty * i.bonus}</td>
              </tr>`).join("")}
          </tbody>
        </table>
      </div>
    `).join("");
  }

  function exportCSV() {
    const purchases = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
    if (purchases.length === 0) {
      alert("保存データがありません。");
      return;
    }
    let csv = "チケット番号,商品ID,商品名,単価,数量,合計金額,応援カード枚数\n";
    purchases.forEach(p => {
      p.items.forEach(item => {
        csv += [
          p.ticket,
          item.id,
          item.name,
          item.price,
          item.qty,
          item.price * item.qty,
          item.bonus * item.qty
        ].join(",") + "\n";
      });
    });

    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "purchase_data.csv";
    a.click();
    URL.revokeObjectURL(url);
  }

  function clearStorage() {
    if (confirm("すべての保存データを削除します。よろしいですか？")) {
      localStorage.removeItem(STORAGE_KEY);
      alert("保存データを削除しました。");
      document.getElementById("data-list").innerHTML = "";
    }
  }

  function formatReadable(data) {
    if (!data) return "";
    let text = `チケット番号: ${data.ticket}\n`;
    text += `合計金額: ￥${data.items.reduce((acc, cur) => acc + cur.price * cur.qty, 0).toLocaleString()}\n`;
    text += `応援カード枚数: ${data.items.reduce((acc, cur) => acc + cur.bonus * cur.qty, 0)}\n\n`;
    data.items.forEach(item => {
      text += `・${item.name}（ID:${item.id}） x ${item.qty} ￥${(item.price * item.qty).toLocaleString()}（カード: ${item.qty * item.bonus}）\n`;
    });
    return text;
  }
</script>

</body>
</html>
