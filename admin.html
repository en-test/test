<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>物販管理（運営用）</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body { font-family: sans-serif; padding: 1rem; }
    #reader { width: 100%; max-width: 400px; margin-bottom: 1em; }
    .section { margin: 1.5em 0; }
    .entry { border: 1px solid #ccc; padding: 0.5em; margin-bottom: 0.5em; }
    table { border-collapse: collapse; width: 100%; margin-top: 0.5em; }
    th, td { border: 1px solid #ccc; padding: 0.5em; text-align: center; }
    th { background: #f5f5f5; }
  </style>
</head>
<body>

  <h1>物販管理（運営用）</h1>

  <div class="section">
    <h2>① QRコード読み取り</h2>
    <div id="reader"></div>
    <button onclick="startScan()">スキャン開始</button>
    <button onclick="stopScan()">スキャン停止</button>
  </div>

  <div class="section">
    <h2>② 読み取り結果</h2>
    <div id="scan-result" style="border:1px solid #ccc; padding:1em; min-height:120px;">未読み取り</div>
    <button onclick="saveData()">保存する</button>
  </div>

  <div class="section">
    <h2>③ 保存データ一覧</h2>
    <button onclick="showData()">一覧を表示</button>
    <div id="data-list"></div>
  </div>

  <div class="section">
    <h2>④ CSV出力</h2>
    <button onclick="exportCSV()">CSVをダウンロード</button>
  </div>

  <script>
    const GOODS_MASTER = [
      { id: 1, name: "Tシャツ", price: 3000, bonus: 1 },
      { id: 2, name: "タオル", price: 1500, bonus: 1 },
      { id: 3, name: "缶バッジ", price: 500, bonus: 0 },
      { id: 4, name: "ステッカー", price: 300, bonus: 0 },
      { id: 5, name: "ペンライト", price: 2000, bonus: 1 },
      { id: 6, name: "リストバンド", price: 800, bonus: 0 },
      { id: 7, name: "ポスター", price: 1000, bonus: 0 },
      { id: 8, name: "アクリルスタンド", price: 1800, bonus: 1 },
      { id: 9, name: "キーホルダー", price: 1200, bonus: 0 },
      { id: 10, name: "クリアファイル", price: 400, bonus: 0 },
      { id: 11, name: "マグカップ", price: 1500, bonus: 0 },
      { id: 12, name: "スマホリング", price: 1000, bonus: 0 },
      { id: 13, name: "ネックストラップ", price: 700, bonus: 0 },
      { id: 14, name: "メモ帳", price: 500, bonus: 0 },
      { id: 15, name: "ピンバッジ", price: 600, bonus: 0 },
      { id: 16, name: "マフラータオル", price: 1800, bonus: 1 },
      { id: 17, name: "ショッピングバッグ", price: 1000, bonus: 0 },
      { id: 18, name: "うちわ", price: 400, bonus: 0 },
      { id: 19, name: "ラバーバンド", price: 500, bonus: 0 },
      { id: 20, name: "カレンダー", price: 1200, bonus: 0 },
      { id: 21, name: "ボールペン", price: 300, bonus: 0 },
      { id: 22, name: "パーカー", price: 4500, bonus: 1 },
      { id: 23, name: "ブロマイド", price: 200, bonus: 0 },
      { id: 24, name: "巾着", price: 900, bonus: 0 },
      { id: 25, name: "DVD", price: 3500, bonus: 1 },
      { id: 26, name: "トートバッグ", price: 2000, bonus: 1 },
      { id: 27, name: "イヤホン", price: 2500, bonus: 1 },
      { id: 28, name: "メガネ拭き", price: 600, bonus: 0 },
      { id: 29, name: "ノート", price: 400, bonus: 0 },
      { id: 30, name: "お守り", price: 800, bonus: 0 }
    ];

    let lastScanned = null;
    const STORAGE_KEY = "purchases";
    let qrScanner = null;

    function startScan() {
      if (qrScanner) return;
      qrScanner = new Html5Qrcode("reader");
      qrScanner.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        (decoded) => {
          try {
            const data = JSON.parse(decoded);
            lastScanned = data;
            document.getElementById("scan-result").innerHTML = renderScanResult(data);
            stopScan();
          } catch {
            document.getElementById("scan-result").textContent = "読み取り失敗（JSON形式ではない）";
            lastScanned = null;
          }
        }
      ).catch(err => alert("カメラ起動失敗: " + err));
    }

    function stopScan() {
      if (qrScanner) {
        qrScanner.stop().then(() => {
          qrScanner.clear();
          qrScanner = null;
        });
      }
    }

    function renderScanResult(data) {
      let html = `<p><strong>整理番号:</strong> ${data.serial}</p>`;
      html += `<p><strong>チケット番号:</strong> ${data.ticket}</p>`;
      html += `<p><strong>合計点数:</strong> ${data.totalQty} / <strong>合計金額:</strong> ￥${data.totalPrice} / <strong>応援カード:</strong> ${data.totalBonus}</p>`;

      if (!data.goods?.length) return html + `<p>商品データがありません。</p>`;

      html += `<table><thead><tr><th>商品名</th><th>数量</th></tr></thead><tbody>`;
      data.goods.forEach(item => {
        const m = GOODS_MASTER.find(g => g.id === item.id) || { name: `ID:${item.id}` };
        html += `<tr><td>${m.name}</td><td>${item.qty}</td></tr>`;
      });
      html += `</tbody></table>`;
      return html;
    }

    function saveData() {
      if (!lastScanned) return alert("QRコードを読み取ってください");
      const existing = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
      if (existing.some(e => e.serial === lastScanned.serial)) {
        return alert("この整理番号は既に保存済みです。");
      }

      const record = {
        serial: lastScanned.serial,
        ticket: lastScanned.ticket,
        totalQty: lastScanned.totalQty,
        totalPrice: lastScanned.totalPrice,
        totalBonus: lastScanned.totalBonus,
        goods: lastScanned.goods
      };
      existing.push(record);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(existing));
      alert("保存しました。");
    }

    function showData() {
      const list = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
      const div = document.getElementById("data-list");
      if (!list.length) return div.innerHTML = "<p>保存データはありません。</p>";

      div.innerHTML = list.map(entry => {
        let row = `<div class="entry"><p><strong>整理番号:</strong> ${entry.serial} / <strong>チケット番号:</strong> ${entry.ticket}</p>`;
        row += `<p><strong>点数:</strong> ${entry.totalQty} / <strong>金額:</strong> ￥${entry.totalPrice} / <strong>カード:</strong> ${entry.totalBonus}</p>`;
        row += `<details><summary>商品詳細</summary><table><thead><tr><th>商品名</th><th>数量</th></tr></thead><tbody>`;
        entry.goods.forEach(i => {
          const m = GOODS_MASTER.find(g => g.id === i.id) || { name: `ID:${i.id}` };
          row += `<tr><td>${m.name}</td><td>${i.qty}</td></tr>`;
        });
        row += `</tbody></table></details></div>`;
        return row;
      }).join("");
    }

    function exportCSV() {
      const data = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
      if (!data.length) return alert("保存データがありません。");
      let csv = "整理番号,チケット番号,合計点数,合計金額,カード枚数\n";
      data.forEach(e => {
        csv += `${e.serial},${e.ticket},${e.totalQty},${e.totalPrice},${e.totalBonus}\n`;
      });
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "purchase_log.csv";
      a.click();
    }
  </script>

</body>
</html>
